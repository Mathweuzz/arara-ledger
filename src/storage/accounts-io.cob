>>SOURCE FORMAT FREE
*> ------------------------------------------------------------
*> Programa: accounts-io.cob
*> Objetivo:
*>   - Subprograma para operar o arquivo ACCOUNTS (INDEXED).
*>   - Operacoes:
*>       'C' = Create (incluir)
*>       'R' = Read   (consultar)
*>       'U' = Update (atualizar)
*>       'L' = List   (listar todas as contas)
*> ------------------------------------------------------------
IDENTIFICATION DIVISION.
PROGRAM-ID. ACCOUNTS-IO.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT ACCOUNTS-FILE ASSIGN TO "data/accounts.dat"
        ORGANIZATION IS INDEXED
        ACCESS MODE   IS DYNAMIC
        RECORD KEY    IS AC-ACCOUNT-ID
        FILE STATUS   IS FS-ACCOUNTS.

DATA DIVISION.
FILE SECTION.

FD  ACCOUNTS-FILE.
COPY "accounts.cpy".

WORKING-STORAGE SECTION.
COPY "common.cpy".

01 FS-ACCOUNTS PIC XX.

LINKAGE SECTION.
01 L-OP-CODE          PIC X.
01 L-ACCOUNT-ID       PIC 9(10).
01 L-PARENT-ID        PIC 9(10).
01 L-ACCOUNT-NAME     PIC X(40).
01 L-ACCOUNT-TYPE     PIC X(1).
01 L-CURRENCY         PIC X(3).
01 L-OPENED-DATE      PIC 9(8).
01 L-STATUS           PIC X(1).
01 L-RETURN-STATUS    PIC XX.

PROCEDURE DIVISION USING
    L-OP-CODE
    L-ACCOUNT-ID
    L-PARENT-ID
    L-ACCOUNT-NAME
    L-ACCOUNT-TYPE
    L-CURRENCY
    L-OPENED-DATE
    L-STATUS
    L-RETURN-STATUS.

MAIN-PARA.
    MOVE SPACES TO L-RETURN-STATUS.
    MOVE SPACES TO FS-ACCOUNTS.

    OPEN I-O ACCOUNTS-FILE
    IF FS-ACCOUNTS NOT = FS-OK
       MOVE FS-ACCOUNTS TO L-RETURN-STATUS
       GOBACK
    END-IF

    EVALUATE L-OP-CODE
       WHEN "C"
          PERFORM CREATE-ACCOUNT
       WHEN "R"
          PERFORM READ-ACCOUNT
       WHEN "U"
          PERFORM UPDATE-ACCOUNT
       WHEN "L"
          PERFORM LIST-ACCOUNTS
       WHEN OTHER
          MOVE "OP" TO L-RETURN-STATUS
    END-EVALUATE

    CLOSE ACCOUNTS-FILE
    GOBACK
    .

CREATE-ACCOUNT.
    MOVE L-ACCOUNT-ID       TO AC-ACCOUNT-ID
    MOVE L-PARENT-ID        TO AC-PARENT-ID
    MOVE L-ACCOUNT-NAME     TO AC-ACCOUNT-NAME
    MOVE L-ACCOUNT-TYPE     TO AC-ACCOUNT-TYPE
    MOVE L-CURRENCY         TO AC-CURRENCY
    MOVE L-OPENED-DATE      TO AC-OPENED-DATE
    MOVE L-STATUS           TO AC-STATUS

    WRITE AC-RECORD
    MOVE FS-ACCOUNTS TO L-RETURN-STATUS
    .

READ-ACCOUNT.
    MOVE L-ACCOUNT-ID TO AC-ACCOUNT-ID

    READ ACCOUNTS-FILE KEY IS AC-ACCOUNT-ID
    MOVE FS-ACCOUNTS TO L-RETURN-STATUS

    IF FS-ACCOUNTS = FS-OK
       MOVE AC-PARENT-ID    TO L-PARENT-ID
       MOVE AC-ACCOUNT-NAME TO L-ACCOUNT-NAME
       MOVE AC-ACCOUNT-TYPE TO L-ACCOUNT-TYPE
       MOVE AC-CURRENCY     TO L-CURRENCY
       MOVE AC-OPENED-DATE  TO L-OPENED-DATE
       MOVE AC-STATUS       TO L-STATUS
    END-IF
    .

UPDATE-ACCOUNT.
    MOVE L-ACCOUNT-ID TO AC-ACCOUNT-ID

    READ ACCOUNTS-FILE KEY IS AC-ACCOUNT-ID
    IF FS-ACCOUNTS = FS-OK
       MOVE L-PARENT-ID        TO AC-PARENT-ID
       MOVE L-ACCOUNT-NAME     TO AC-ACCOUNT-NAME
       MOVE L-ACCOUNT-TYPE     TO AC-ACCOUNT-TYPE
       MOVE L-CURRENCY         TO AC-CURRENCY
       MOVE L-OPENED-DATE      TO AC-OPENED-DATE
       MOVE L-STATUS           TO AC-STATUS
       REWRITE AC-RECORD
    END-IF

    MOVE FS-ACCOUNTS TO L-RETURN-STATUS
    .

LIST-ACCOUNTS.
    *> Listagem sequencial de todas as contas por ordem de chave
    MOVE 0 TO AC-ACCOUNT-ID

    START ACCOUNTS-FILE KEY IS >= AC-ACCOUNT-ID
    IF FS-ACCOUNTS NOT = FS-OK
       MOVE FS-ACCOUNTS TO L-RETURN-STATUS
       EXIT PARAGRAPH
    END-IF

    PERFORM UNTIL FS-ACCOUNTS NOT = FS-OK
       READ ACCOUNTS-FILE NEXT
       IF FS-ACCOUNTS = FS-OK
          DISPLAY "ID: " AC-ACCOUNT-ID
                  "  PAI: " AC-PARENT-ID
                  "  TIPO: " AC-ACCOUNT-TYPE
                  "  STATUS: " AC-STATUS
       END-IF
    END-PERFORM

    MOVE FS-OK TO L-RETURN-STATUS
    .
